!function(e,t){for(var r in t)e[r]=t[r]}(exports,function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=1)}([function(e,t){e.exports=require("worker_threads")},function(e,t,r){e.exports=r(2)},function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(o,s){function i(e){try{u(n.next(e))}catch(e){s(e)}}function c(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){e.done?o(e.value):new r(function(t){t(e.value)}).then(i,c)}u((n=n.apply(e,t||[])).next())})},o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),r(3);const i=o(r(4)),c=s(r(5)),u=r(0),l=r(7).parseArgs(process.argv.slice(2));new class{constructor(e,t,n=0,o=0,s=null){if(this.Workers=[],this.Instances=0,this.willClose=!1,!e)throw new Error("Parentpid is null");if(!t)throw new Error("no working dir");if(!s)throw new Error("no worker");this.Port=n,this.Pid=e,this.Workingdir=t,this.WorkerPath=s,this.Instances=o>0?o:r(8).cpus().length,this.Server=c.default(i.createServer(this.handler.bind(this)))}listen(){this.Server.listen(this.Port,"localhost",()=>{this.AddressInfo=this.Server.address();const e=JSON.stringify({port:this.AddressInfo.port,addr:this.AddressInfo.address});console.log(`[${this.Pid}] ${e}`),this.SetupWorkers(),setInterval(()=>this.TryKillParent(),1e3)})}handler(e,t){return n(this,void 0,void 0,function*(){try{if("POST"===e.method){const r=yield this.Readbody(e),n=this.Workers[Math.floor(Math.random()*this.Workers.length)];n.postMessage({opt:r.opt||"execute",module:r.module,data:r.data}),n.once("message",e=>{if("string"!=typeof e)try{const r=JSON.stringify(e);t.setHeader("Content-Type","application/json"),t.end(r)}catch(e){return this.SendError(t,e)}else t.setHeader("Content-Type","text/plain"),t.end(e)})}else t.end()}catch(e){return this.SendError(t,e)}})}SendError(e,t){e.statusCode=500,e.end(JSON.stringify({error:t.stack||null,message:t.message||t}))}Readbody(e){return new Promise((t,r)=>{let n="";e.on("data",e=>{n+=e}),e.on("end",()=>{t(JSON.parse(n))})})}TryKillParent(){try{process.kill(this.Pid,0)}catch(e){if("EPERM"==e.code)throw new Error("No permission to check parentPid");this.Exit()}}Exit(){this.willClose=!0,this.Server.close(e=>n(this,void 0,void 0,function*(){for(const e of this.Workers)yield e.terminate();if(e)return console.log(e),process.exit(1);process.exit(0)}))}SetupWorkers(){for(let e=0;e<this.Instances;e++)this.CreateWorker()}CreateWorker(){const e=new u.Worker(this.WorkerPath,{workerData:{workingdir:this.Workingdir}});this.Workers.push(e),e.on("error",e=>{throw e}),e.on("exit",()=>{e.removeAllListeners(),this.Workers.splice(this.Workers.indexOf(e),1),this.willClose||this.CreateWorker()})}}(l.pid,l.workingdir,l.port,l.instances,l.workerpath).listen()},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=/\n(?!$)/g,o="__ns_newline__";function s(e){const t=e.write;e.write=function(e){if("string"==typeof e){const r=Array.prototype.slice.call(arguments,0);r[0]=i(e),t.apply(this,r)}else t.apply(this,arguments)}}function i(e){return e.replace(n,o)}s(process.stdout),s(process.stderr),t.encodeNewlinesWrittenToStream=s},function(e,t){e.exports=require("http")},function(e,t,r){"use strict";var n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const o=n(r(6));t.default=(e,t)=>{t=void 0===t?1/0:t;const r=new Map;let n=!1,s=!0;return e instanceof o.Server?e.on("secureConnection",i):e.on("connection",i),e.on("request",function(e,t){r.set(e.socket,r.get(e.socket)+1),t.once("finish",()=>{const t=r.get(e.socket)-1;r.set(e.socket,t),n&&0===t&&e.socket.end()})}),e.stop=function(o){setImmediate(()=>{n=!0,t<1/0&&setTimeout(u,t).unref(),e.close(e=>{o&&o(e,s)}),r.forEach(c)})},e._pendingSockets=r,e;function i(e){r.set(e,0),e.once("close",()=>r.delete(e))}function c(e,t){0===e&&t.end()}function u(){s=!1,r.forEach((e,t)=>t.end()),setImmediate(()=>{r.forEach((e,t)=>t.destroy())})}}},function(e,t){e.exports=require("https")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseArgs=function(e){const t={};let r=null;return e.forEach(e=>{if(0===e.indexOf("--")){const n=e.substring(2).toLowerCase();t[n]=void 0,r=n}else r&&(t[r]=e,r=null)}),t}},function(e,t){e.exports=require("os")}]));